<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>StimulMap</title>
		<link rel="stylesheet" href="main.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<!-- Favicon (inline SVG data URI) -->
		<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='32' fill='%23537E70'/%3E%3Ctext x='32' y='40' font-size='32' text-anchor='middle' fill='white' font-family='Arial'%3ES%3C/text%3E%3C/svg%3E">
		<!-- 2GIS MapGL JS API: async loading with callback -->
		<script>
			// –í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä. –ü–æ—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π –∫–ª—é—á –∏–ª–∏ –≤—ã–Ω–µ—Å–∏ –µ–≥–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª, –Ω–µ –∫–æ–º–º–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
			window.MAPGL_KEY = '285d3b2b-96ab-4fe5-a700-12ef370d7085';
			// –ù–∞—Å—Ç—Ä–æ–π–∫–∞: –∞–≤—Ç–æ-–æ—Ç–∫—Ä—ã–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏
			window.AUTO_OPEN_ORG_DIALOG = true; // –≤—ã—Å—Ç–∞–≤–∏ false –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É
			// –•—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç—É –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
			window.APP = { map: null, selectedMarker: null };
			const GEOCODER_BASE = 'https://catalog.api.2gis.com/3.0/items/geocode';
			async function reverseGeocode(lat, lon) {
				const key = window.MAPGL_KEY;
				if (!key) return { error: '–ù–µ—Ç –∫–ª—é—á–∞' };
				const url = `${GEOCODER_BASE}?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&fields=items.point&key=${encodeURIComponent(key)}`;
				try {
					const res = await fetch(url);
					const json = await res.json();
					if (!res.ok) return { error: json?.meta?.code || '–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–µ—Ä–∞' };
					const items = (json?.result?.items || []).filter(Boolean);
					if (!items.length) return { error: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ' };
					return { items };
				} catch (e) {
					return { error: e.message };
				}
			}
			function setAddressLoading() {
				const pill = document.getElementById('selected-address');
				if (pill){
					pill.classList.add('loading');
					pill.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...';
				}
			}
			function setAddress(text, error=false) {
				const pill = document.getElementById('selected-address');
				if (!pill) return;
				pill.classList.remove('loading');
				pill.textContent = text;
				pill.dataset.error = error ? '1':'0';
				pill.classList.toggle('error', !!error);
				const createBtn = document.getElementById('open-org-dialog');
				if (createBtn) {
					createBtn.disabled = !!error || !text || text.startsWith('–í—ã–±–µ—Ä–∏—Ç–µ');
				}
			}
			function buildBestCandidate(items){
				// –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ id
				const seen = new Set();
				const unique = [];
				for (const it of items){
					if (!it.id || seen.has(it.id)) continue;
					seen.add(it.id); unique.push(it);
				}
				// –°–æ—Ä—Ç–∏—Ä—É–µ–º: building > place > adm_div; –Ω–∞–ª–∏—á–∏–µ address_name / building_name –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ
				const weightType = (t)=> t==='building'?3 : (t==='place'?2 : (t==='adm_div'?1:0));
				unique.sort((a,b)=>{
					const wa = weightType(a.type); const wb = weightType(b.type);
					if (wb!==wa) return wb-wa;
					const aa = (a.address_name?1:0)+(a.building_name?1:0);
					const ab = (b.address_name?1:0)+(b.building_name?1:0);
					if (ab!==aa) return ab-aa;
					return 0;
				});
				return unique;
			}
			function formatAddress(raw){
				return (raw||'').replace(/\s+/g,' ').trim();
			}
			function placeSelectionMarker(lon, lat) {
				if (!window.APP.map) return;
				if (window.APP.selectedMarker) {
					window.APP.selectedMarker.destroy();
				}
				window.APP.selectedMarker = new mapgl.Marker(window.APP.map, {
					coordinates: [lon, lat],
					icon: undefined,
				});
			}
			// ====== –†–∞–±–æ—Ç–∞ —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏ –ø–æ –∞–¥—Ä–µ—Å—É ======
			const ORG_API = 'http://81.29.146.35:8080';
			const ALL_PARAMS = ['appearance','lighting','smell','temperature','tactility','signage','intuitiveness','staff_attitude','people_density','self_service','calmness'];
			function getToken(){ try { return localStorage.getItem('auth_token'); } catch { return null; } }
			function decodeJWT(token){
				try { const p = token.split('.')[1]; return JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/'))); } catch { return null; }
			}
			async function fetchJSON(url, opts){
				try {
					const res = await fetch(url, opts);
					let data = null; try { data = await res.json(); } catch { data = {}; }
					return { ok: res.ok, status: res.status, data };
				} catch(e){
					return { ok:false, status:0, data:{ error:'Network error', detail: e.message } };
				}
			}
			function diagnoseNetworkError(errObj, endpoint){
				if(!errObj || errObj.status !== 0) return '';
				let hints = [];
				hints.push('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å '+endpoint);
				if(!navigator.onLine) hints.push('–ü–æ—Ö–æ–∂–µ, –Ω–µ—Ç —Å–µ—Ç–∏ (navigator.offLine)');
				if(location.protocol === 'file:') hints.push('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–∞–∫ file:// ‚Äî –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å CORS');
				if(location.hostname === 'localhost' || location.hostname === '127.0.0.1') hints.push('–ü—Ä–æ–≤–µ—Ä—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ backend –Ω–∞ :8080 –∏ –Ω–µ—Ç –ª–∏ firewall');
				hints.push('–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å Network –≤ DevTools (–∑–∞–ø—Ä–æ—Å –º–æ–≥ –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω CORS)');
				return hints.join('\n');
			}
			async function getUserParamNames(){
				const token = getToken(); if(!token) return ALL_PARAMS; // –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –≤—Å–µ
				const dec = decodeJWT(token); if(!dec || !dec.user_id) return ALL_PARAMS;
				try {
					const { ok, data } = await fetchJSON(`${ORG_API}/user-params/${dec.user_id}`, { headers:{ Authorization:'Bearer '+token }});
					if (!ok) return ALL_PARAMS;
					const selected = ALL_PARAMS.filter(k => data[k] === true);
					return selected.length ? selected : ALL_PARAMS; // –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ ‚Äî –≤—Å–µ
				} catch { return ALL_PARAMS; }
			}
			function renderExistingOrg(orgInfo, avgInfo){
				openOrgInfoDialog(orgInfo, avgInfo);
			}
			function hideExistingOrg(){ /* modal approach, no inline cleanup needed */ }
			// –Ø–í–ù–´–ô –®–ê–ì: –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –∞–¥—Ä–µ—Å—É (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –µ—ë ID)
			async function fetchOrganizationByAddress(address){
				const normalized = (address||'').trim();
				if (!normalized) return { ok:false, status:400, data:{ error:'empty address'} };
				return await fetchJSON(`${ORG_API}/organization/public/by-address`, {
					method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ address: normalized })
				});
			}
			function buildOrgInfoHTML(org, avg){
				// –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—è: id, address, organization_type, map_path, picture_path
				const p = (avg?.Params||[]).map(x=>`<code>${x}</code>`).join(' ');
				const average = avg?.Average != null ? Number(avg.Average).toFixed(2) : '‚Äî';
				const mapImg = org.map_path ? `<div class="img-box"><img src="${ORG_API}/organization/${org.id}/image/map" alt="–ö–∞—Ä—Ç–∞" loading="lazy"></div>` : '';
				const picImg = org.picture_path ? `<div class="img-box"><img src="${ORG_API}/organization/${org.id}/image/picture" alt="–§–æ—Ç–æ" loading="lazy"></div>` : '';
				return `
					<div class="org-info-top">
						<div class="org-info-line"><span class="lbl">–ê–¥—Ä–µ—Å:</span> <span class="val addr">${org.address||'-'}</span> <span class="dot">‚Ä¢</span> <span class="lbl">–¢–∏–ø:</span> <span class="val type">${org.organization_type||'-'}</span></div>
						<div class="org-info-id">ID: <span class="val">${org.id}</span></div>
					</div>
					<div class="org-info-images">${mapImg}${picImg}</div>
					<div class="org-info-average">–°—Ä–µ–¥–Ω–µ–µ: <span class="val">${average}</span></div>
					<div class="org-comments-wrapper">
						<h3 class="org-comments-title">–û—Ç–∑—ã–≤—ã</h3>
						<div id="org-comments" class="org-comments" data-org-id="${org.id}">
							<p class="org-comments-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</p>
						</div>
					</div>
				`;
			}
			function openOrgInfoDialog(org, avg){
				const dialog = document.getElementById('org-info-dialog');
				const overlay = document.getElementById('org-info-overlay');
				const body = document.getElementById('org-info-body');
				if (!dialog || !overlay || !body) return;
				body.innerHTML = buildOrgInfoHTML(org, avg);
				dialog.classList.add('open');
				dialog.removeAttribute('aria-hidden');
				overlay.classList.add('visible');
				overlay.removeAttribute('aria-hidden');
				// –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã
				loadOrganizationComments(org.id);
				prepareQuickComment(org.id);
			}
			function closeOrgInfoDialog(){
				const dialog = document.getElementById('org-info-dialog');
				const overlay = document.getElementById('org-info-overlay');
				if (!dialog || !overlay) return;
				dialog.classList.remove('open');
				dialog.setAttribute('aria-hidden','true');
				overlay.classList.remove('visible');
				overlay.setAttribute('aria-hidden','true');
			}
						// ====== –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ======
						async function loadOrganizationComments(orgId){
							const wrap = document.getElementById('org-comments');
							if(!wrap) return;
							wrap.innerHTML = '<p class="org-comments-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</p>';
							const token = getToken();
							if(!token){
								wrap.innerHTML = '<p class="org-comments-empty">–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç–∑—ã–≤—ã, –≤–æ–π–¥–∏—Ç–µ.</p>';
								return;
							}
							try {
								const res = await fetch(`${ORG_API}/organization/${orgId}/comments`, { headers:{ Authorization:'Bearer '+token }});
								if(!res.ok){
									wrap.innerHTML = '<p class="org-comments-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã</p>';
									return;
								}
								const data = await res.json();
								const items = Array.isArray(data.items)? data.items: [];
								if(!items.length){
									wrap.innerHTML = '<p class="org-comments-empty">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>';
									return;
								}
								wrap.innerHTML = items.map(renderCommentItem).join('');
							} catch(e){
								wrap.innerHTML = '<p class="org-comments-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
							}
						}
						function renderCommentItem(item){
							const hasVal = typeof item.avg_val === 'number' && item.avg_val > 0;
							const val = hasVal ? `<span class="cmt-val" title="–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞">${Number(item.avg_val).toFixed(1)}</span>` : '';
							const user = (item.user_name||'‚Äî').replace(/</g,'&lt;').replace(/>/g,'&gt;');
							const text = (item.text||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
							return `<div class="comment-item">${val}<div class="cmt-main"><div class="cmt-user">${user}</div><div class="cmt-text">${text||'<em class=\"muted\">(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)</em>'}</div></div></div>`;
						}
						// ===== –ë—ã—Å—Ç—Ä—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π =====
						function prepareQuickComment(orgId){
							const input = document.getElementById('quick-comment-text');
							const sendBtn = document.getElementById('quick-comment-send');
							const status = document.getElementById('quick-comment-status');
							const detBtn = document.getElementById('open-detailed-comment');
							if(!input || !sendBtn){ return; }
							input.value=''; status.textContent=''; sendBtn.disabled = true;
							input.oninput = ()=>{ sendBtn.disabled = !input.value.trim(); };
							sendBtn.onclick = async ()=>{
								const text = input.value.trim();
								if(!text) return;
								const token = getToken();
								if(!token){ status.textContent='–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å'; status.className='oqc-status error'; return; }
								sendBtn.disabled = true; status.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...'; status.className='oqc-status saving';
								try {
									const payload = { organization_id: orgId, text };
									let res;
									try { res = await fetch(`${ORG_API}/organization/comment`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(payload) }); }
									catch(netErr){
										console.error('Quick comment network error', netErr);
										status.textContent='–°–µ—Ç—å: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å'; status.className='oqc-status error';
										const diag = diagnoseNetworkError({ status:0 }, '/organization/comment');
										if(diag) console.warn(diag);
										sendBtn.disabled=false; return;
									}
									if(!res.ok){ const js = await res.json().catch(()=>({})); status.textContent = js.error||`–û—à–∏–±–∫–∞ ${res.status}`; status.className='oqc-status error'; sendBtn.disabled=false; return; }
									status.textContent='–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'; status.className='oqc-status ok'; input.value='';
									// –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
									loadOrganizationComments(orgId);
								} catch(e){ status.textContent='–û—à–∏–±–∫–∞'; status.className='oqc-status error'; console.error('Quick comment unexpected', e); sendBtn.disabled=false; }
							};
							if(detBtn){ detBtn.onclick = ()=> openDetailedDialog(orgId); }
						}
						// ===== –î–µ—Ç–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ =====
						let lastFocusBeforeDetail = null;
						function openDetailedDialog(orgId){
							const dlg = document.getElementById('detail-dialog');
							const ov = document.getElementById('detail-overlay');
							if(!dlg||!ov) return;
							lastFocusBeforeDetail = document.activeElement instanceof HTMLElement ? document.activeElement : null;
							document.getElementById('detail-org-id').value = orgId;
							dlg.classList.add('open'); dlg.removeAttribute('aria-hidden');
							ov.classList.add('visible'); ov.removeAttribute('aria-hidden');
							// –§–æ–∫—É—Å —Å—Ç–∞–≤–∏–º –Ω–∞ textarea –æ–±—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
							const focusTarget = document.getElementById('detail-text');
							if(focusTarget) setTimeout(()=>focusTarget.focus(), 30);
						}
						function closeDetailedDialog(){
							const dlg = document.getElementById('detail-dialog');
							const ov = document.getElementById('detail-overlay');
							if(!dlg||!ov) return;
							// –ï—Å–ª–∏ —Ñ–æ–∫—É—Å –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ª–æ–≥–∞ ‚Äî —É–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–¥ aria-hidden
							const active = document.activeElement;
							if(active && dlg.contains(active)) { try { active.blur(); } catch{} }
							dlg.classList.remove('open');
							// –û—Ç–ª–æ–∂–µ–Ω–Ω–æ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º aria-hidden –ø–æ—Å–ª–µ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
							setTimeout(()=>{ dlg.setAttribute('aria-hidden','true'); }, 0);
							ov.classList.remove('visible'); ov.setAttribute('aria-hidden','true');
							// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ–∫—É—Å–∞
							if(lastFocusBeforeDetail && document.contains(lastFocusBeforeDetail)) {
								try { lastFocusBeforeDetail.focus(); } catch{}
							} else {
								const fallback = document.getElementById('open-detailed-comment') || document.getElementById('auth-btn');
								if(fallback) try { fallback.focus(); } catch{}
							}
						}
						document.addEventListener('click',(e)=>{
							if(e.target && (e.target.id==='detail-close' || e.target.id==='detail-cancel' || e.target.id==='detail-overlay')) closeDetailedDialog();
						});
						document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeDetailedDialog(); }});
						document.addEventListener('submit', async (e)=>{
							if(e.target && e.target.id==='detail-form'){
								e.preventDefault();
								const form = e.target;
								const statusEl = document.getElementById('detail-status');
								const token = getToken();
								if(!token){ statusEl.textContent='–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏'; statusEl.className='detail-status error'; return; }
								statusEl.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...'; statusEl.className='detail-status saving';
								const fd = new FormData(form);
								const payload = { organization_id: Number(fd.get('organization_id')) };
								const text = (fd.get('text')||'').toString().trim(); if(text) payload.text=text;
								const keys = ['appearance','lighting','smell','temperature','tactility','signage','intuitiveness','staff_attitude','people_density','self_service','calmness'];
								for(const k of keys){
									const v = fd.get(k+'_value');
									if(v){ payload[k+'_value'] = Number(v); }
								}
								console.debug('Submitting detailed comment payload', payload);
								if(!payload.text && Object.keys(payload).length === 1){
									statusEl.textContent='–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω—É –æ—Ü–µ–Ω–∫—É';
									statusEl.className='detail-status error';
									return;
								}
								try {
									let res;
									try { res = await fetch(`${ORG_API}/organization/comment`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(payload) }); }
									catch(netErr){
										console.error('Detailed comment network error', netErr);
										statusEl.textContent='–°–µ—Ç—å: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è'; statusEl.className='detail-status error';
										const diag = diagnoseNetworkError({ status:0 }, '/organization/comment');
										if(diag) console.warn(diag);
										return;
									}
									if(!res.ok){ const js = await res.json().catch(()=>({})); statusEl.textContent = js.error||`–û—à–∏–±–∫–∞ ${res.status}`; statusEl.className='detail-status error'; return; }
									statusEl.textContent='–ì–æ—Ç–æ–≤–æ'; statusEl.className='detail-status ok';
									loadOrganizationComments(payload.organization_id);
									setTimeout(()=>{ closeDetailedDialog(); }, 600);
								} catch(err){ statusEl.textContent='–û—à–∏–±–∫–∞: '+err.message; statusEl.className='detail-status error'; console.error('Detailed comment unexpected', err); }
							}
						});
						// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–º–∞–π–ª–∏–∫–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã
						const EMOJI_MAP = [
							{val:1, img:'img/icons/emoji-sad.png', alt:'1'},
							{val:2, img:'img/icons/emoji-think-left.png', alt:'2'},
							{val:3, img:'img/icons/emoji-quite.png', alt:'3'},
							{val:4, img:'img/icons/emoji-think-right.png', alt:'4'},
							{val:5, img:'img/icons/emoji.png', alt:'5'}
						];
						function updateDetailSubmitState(){
							const form = document.getElementById('detail-form'); if(!form) return;
							const submitBtn = document.getElementById('detail-submit'); if(!submitBtn) return;
							const textVal = (document.getElementById('detail-text')?.value||'').trim();
							const keys = ['appearance','lighting','smell','temperature','tactility','signage','intuitiveness','staff_attitude','people_density','self_service','calmness'];
							let any=false;
							for(const k of keys){ const hv=form.querySelector(`input[name='${k}_value']`); if(hv && hv.value){ any=true; break; } }
							submitBtn.disabled = !(any || textVal);
						}
						function initDetailEmojis(){
							const containers = document.querySelectorAll('.crit-emojis');
							containers.forEach(c=>{
								// –ï—Å–ª–∏ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ) ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
								if(c.children && c.children.length) return;
								const param = c.dataset.param;
								c.innerHTML = EMOJI_MAP.map(e=>`<button type="button" class="emoji-rate" data-param="${param}" data-value="${e.val}" title="${e.alt}"><img src="${e.img}" alt="${e.alt}"/></button>`).join('');
							});
							updateDetailSubmitState();
						}
						document.addEventListener('click',(e)=>{
							const btn = e.target.closest && e.target.closest('.emoji-rate');
							if(!btn) return;
							const param = btn.dataset.param; const val = btn.dataset.value;
							const group = document.querySelectorAll(`.emoji-rate[data-param='${param}']`);
							const hidden = document.querySelector(`input[name='${param}_value']`);
							const alreadySelected = btn.classList.contains('selected');
							group.forEach(b=> b.classList.remove('selected'));
							if(alreadySelected){
								if(hidden) hidden.value='';
							}else{
								btn.classList.add('selected');
								if(hidden) hidden.value = val;
							}
							updateDetailSubmitState();
						});
						// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–º–∞–π–ª–∏–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
						if(document.readyState === 'complete' || document.readyState === 'interactive'){
							/* –ø—É—Å—Ç–æ: —Ç–µ–ø–µ—Ä—å –≤—ã–∑–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
						}else{
							document.addEventListener('DOMContentLoaded', ()=>{/* –ª–µ–Ω–∏–≤—ã–π */});
						}
						// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º openDetailedDialog —á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å–º–∞–π–ª—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
						const _origOpenDetailedDialog = openDetailedDialog;
						openDetailedDialog = function(orgId){
							_origOpenDetailedDialog(orgId);
							initDetailEmojis();
							updateDetailSubmitState();
						};
			document.addEventListener('click', (e)=>{
				if (e.target && (e.target.id === 'org-info-close' || e.target.id === 'org-info-ok' || e.target.id === 'org-info-overlay')) closeOrgInfoDialog();
			});
			document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeOrgInfoDialog(); });
			let lastOrgLookupSeq = 0;
			async function checkExistingOrganization(address){
				const seq = ++lastOrgLookupSeq;
				const createBtn = document.getElementById('open-org-dialog');
				if (createBtn) createBtn.disabled = true;
				try {
					// STEP 1: –ø–æ–ª—É—á–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é (ID) –ø–æ –∞–¥—Ä–µ—Å—É
					const lookup = await fetchOrganizationByAddress(address);
					if (seq !== lastOrgLookupSeq) return false; // —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –æ—Ç–≤–µ—Ç
					if (!lookup.ok) {
						if (lookup.status === 404) { // –Ω–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å
							if (createBtn) createBtn.disabled = false;
							return false;
						}
						return false;
					}
					// STEP 2: –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
					const paramNames = await getUserParamNames();
					// STEP 3: –∑–∞–ø—Ä–æ—Å —Å—Ä–µ–¥–Ω–µ–≥–æ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
					const orgId = lookup.data.id; // –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—è –∏–∑ JSON
					if (orgId == null) { console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å id –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞', lookup.data); if (createBtn) createBtn.disabled = false; return false; }
					const avgReq = { organization_id: orgId, params: paramNames };
					const avg = await fetchJSON(`${ORG_API}/organization/params/average/with-info`, {
						method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(avgReq)
					});
					if (avg.ok) renderExistingOrg(lookup.data, avg.data); else renderExistingOrg(lookup.data, { Average: null, Params: paramNames });
					return true;
				} catch(e){
					if (createBtn) createBtn.disabled = false;
					return false;
				}
			}
			function initMap() {
				if (!window.MAPGL_KEY || window.MAPGL_KEY.startsWith('PASTE_')) {
					console.warn('MapGL key –Ω–µ –∑–∞–¥–∞–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ window.MAPGL_KEY.');
					return;
				}
				try {
					const DEFAULT_CENTER = [37.625193, 55.695237]; // [lon, lat] –ú–æ—Å–∫–≤–∞ (–∑–∞–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
					const map = new mapgl.Map('map', {
						key: window.MAPGL_KEY,
						center: DEFAULT_CENTER,
						zoom: 13,
					});
					window.APP.map = map;
					new mapgl.Marker(map, { coordinates: DEFAULT_CENTER });
					map.on('click', async (e) => {
						const [lon, lat] = e.lngLat;
						placeSelectionMarker(lon, lat);
						setAddressLoading();
						const { items, error } = await reverseGeocode(lat, lon);
						if (error) { console.warn('GEOCODER ERROR', error); setAddress(`–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω (${error})`, true); return; }
						const best = buildBestCandidate(items);
						if (!best.length){ setAddress('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω', true); return; }
						const top = best[0];
						const addr = formatAddress(top.full_name || top.address_name || top.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç');
						setAddress(addr);
						// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
						const exists = await checkExistingOrganization(addr);
						// –ê–≤—Ç–æ-–æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤–∫–ª—é—á–µ–Ω–æ
						if (!exists && window.AUTO_OPEN_ORG_DIALOG && typeof window.openOrganizationDialog === 'function') {
							setTimeout(()=>{ try { window.openOrganizationDialog(); } catch(e){ console.warn('openOrganizationDialog failed', e); } }, 50);
						}
					});
				} catch (e) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', e);
				}
			}
		</script>
		<script src="https://mapgl.2gis.com/api/js/v1?callback=initMap" async defer></script>
		<script defer src="auth.js"></script>
		<script defer src="organization.js"></script>
		
	  </head>
	  

	
	
<body class="index">
	<!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
	<div id="map" aria-label="–ö–∞—Ä—Ç–∞ 2GIS" role="region"></div>

	<!-- –ü–∞–Ω–µ–ª—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ) -->
	<div class="address-panel" id="address-panel">
		<div id="selected-address" class="address-pill" aria-live="polite">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</div>
		<button id="open-org-dialog" class="button attention-prima small" disabled style="margin-left:8px;" aria-disabled="true">–°–æ–∑–¥–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</button>
	</div>

	<!-- –ë–æ–∫–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
	<button id="side-search-toggle" class="side-search-toggle" aria-label="–ü–æ–∏—Å–∫" aria-haspopup="true" aria-expanded="false">üîç</button>

	<!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ -->
	<aside id="side-search-panel" class="side-search-panel" aria-hidden="true" role="complementary" aria-label="–ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –ø–æ —Ç–∏–ø—É –∏ –ø–æ—Ä–æ–≥—É">
		<header class="ssp-header">
			<h2 class="ssp-title">–ü–æ–∏—Å–∫</h2>
			<button id="side-search-close" class="icon-close small" aria-label="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">√ó</button>
		</header>
		<form id="side-search-form" class="ssp-form" novalidate>
			<div class="ssp-field">
				<label for="ssp-type">–¢–∏–ø</label>
				<input id="ssp-type" name="organization_type" list="ssp-type-list" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ—Ñ–∏—Å" autocomplete="off" />
				<datalist id="ssp-type-list">
					<option value="–æ—Ñ–∏—Å"></option>
					<option value="–º–∞–≥–∞–∑–∏–Ω"></option>
					<option value="–∫–∞—Ñ–µ"></option>
					<option value="other"></option>
					<option value="shop"></option>
					<option value="cafe"></option>
					<option value="office"></option>
				</datalist>
			</div>
			<div class="ssp-field">
				<label for="ssp-threshold">–ü–æ—Ä–æ–≥ (0‚Äì5)</label>
				<input id="ssp-threshold" name="threshold" type="number" min="0" max="5" step="0.1" placeholder="3" />
			</div>
			<div class="ssp-actions">
				<button type="submit" class="button attention-prima small" id="ssp-run">–ù–∞–π—Ç–∏</button>
				<button type="button" class="button attention-tertia small" id="ssp-clear" disabled>–û—á–∏—Å—Ç–∏—Ç—å</button>
			</div>
			<div id="ssp-status" class="ssp-status" aria-live="polite"></div>
		</form>
		<div id="ssp-results" class="ssp-results" aria-live="polite"></div>
	</aside>

	<!-- –ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ / –ø—Ä–æ—Ñ–∏–ª—å -->
	<button id="auth-btn" class="auth-btn" aria-haspopup="dialog" aria-expanded="false">
		<span class="auth-btn__label">–í–æ–π—Ç–∏</span>
		<i class="fa fa-user" aria-hidden="true"></i>
	</button>

    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ–∏—Å–∫–∞ -->
    <button id="open-search" class="fab fab-text" aria-label="–ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π">–ü–æ–∏—Å–∫</button>

    <!-- –î–∏–∞–ª–æ–≥ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É -->
    <div id="search-overlay" class="overlay" aria-hidden="true"></div>
    <div id="search-dialog" class="org-dialog org-dialog--search" role="dialog" aria-modal="true" aria-labelledby="search-title" aria-hidden="true">
        <div class="org-dialog__header">
            <h2 id="search-title">–ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</h2>
            <button class="icon-close small" id="search-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å"><i class="fa fa-times" aria-hidden="true"></i></button>
        </div>
        <form id="search-form" novalidate>
            <div class="field-group">
                <label for="search-type">–¢–∏–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                <select id="search-type" name="organization_type" required>
                    <option value="shop">–ú–∞–≥–∞–∑–∏–Ω</option>
                    <option value="cafe">–ö–∞—Ñ–µ</option>
                    <option value="office">–û—Ñ–∏—Å</option>
                    <option value="other" selected>–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <div class="field-group">
                <label for="search-threshold">–ü–æ—Ä–æ–≥ (0‚Äì5.0)</label>
                <input type="number" id="search-threshold" name="threshold" min="0" max="5" step="0.1" placeholder="3.0" />
            </div>
            <div class="field-group small-info" id="search-status" aria-live="polite"></div>
            <div class="org-dialog__footer">
                <button type="button" class="button attention-tertia ghost" id="search-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="button attention-prima" id="search-submit">–ù–∞–π—Ç–∏</button>
            </div>
        </form>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="search-results-panel" class="search-results-panel hidden" aria-live="polite">
        <div class="srp-header">
            <span id="srp-count">‚Äî</span>
            <button id="srp-clear" class="icon-clear" aria-label="–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã">√ó</button>
        </div>
        <div id="srp-list" class="srp-list"></div>
    </div>

	<!-- Dialog —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
	<div id="org-overlay" class="overlay" aria-hidden="true"></div>
	<div id="org-dialog" class="org-dialog" role="dialog" aria-modal="true" aria-labelledby="org-dialog-title" aria-hidden="true">
		<div class="org-dialog__header">
			<h2 id="org-dialog-title">–ù–æ–≤–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</h2>
			<button class="icon-close" id="org-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ"><i class="fa fa-times" aria-hidden="true"></i></button>
		</div>
		<form id="org-form" novalidate>
			<div class="field-group">
				<label for="org-address">–ê–¥—Ä–µ—Å</label>
				<input type="text" id="org-address" name="address" readonly />
			</div>
			<div class="field-group">
				<label for="org-type">–¢–∏–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
				<select id="org-type" name="organization_type" required>
					<option value="shop">–ú–∞–≥–∞–∑–∏–Ω</option>
					<option value="cafe">–ö–∞—Ñ–µ</option>
					<option value="office">–û—Ñ–∏—Å</option>
					<option value="other" selected>–î—Ä—É–≥–æ–µ</option>
				</select>
			</div>
			<div class="field-group two-cols">
				<div>
					<label for="org-lat">–®–∏—Ä–æ—Ç–∞</label>
					<input type="text" id="org-lat" name="latitude" readonly />
				</div>
				<div>
					<label for="org-lon">–î–æ–ª–≥–æ—Ç–∞</label>
					<input type="text" id="org-lon" name="longitude" readonly />
				</div>
			</div>
			<div class="field-group">
				<label for="org-map-file">–ö–∞—Ä—Ç–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)</label>
				<input type="file" id="org-map-file" accept="image/*" />
			</div>
			<div class="field-group">
				<label for="org-picture-file">–§–æ—Ç–æ</label>
				<input type="file" id="org-picture-file" accept="image/*" />
			</div>
			<div class="org-errors" id="org-errors" aria-live="assertive"></div>
			<div class="org-dialog__footer">
				<button type="button" class="button attention-tertia ghost" id="org-cancel">–û—Ç–º–µ–Ω–∞</button>
				<button type="submit" class="button attention-prima" id="org-submit">–°–æ–∑–¥–∞—Ç—å</button>
			</div>
		</form>
	</div>

		<!-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π bottom-sheet –¥–ª—è –æ–±—â–µ–≥–æ —Ñ–∏–¥–±—ç–∫–∞ -->
		<div id="sheet-overlay" class="overlay" aria-hidden="true"></div>
		<div id="feedback-sheet" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="fb-title">
			<div class="sheet-header">
				<div class="drag-handle" aria-hidden="true"></div>
				<h2 id="fb-title">–û—Ü–µ–Ω–∏—Ç–µ —Å–µ—Ä–≤–∏—Å</h2>
				<button class="icon-close" id="close-sheet" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
			</div>
			<div class="sheet-body">
				<section class="block">
					<p class="question">–ö–∞–∫ –≤–∞–º –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –≤ —Ü–µ–ª–æ–º?</p>
					<div class="rating-scale">
						<button type="button" class="button rate b1" data-value="1">1</button>
						<button type="button" class="button rate b2" data-value="2">2</button>
						<button type="button" class="button rate b3" data-value="3">3</button>
						<button type="button" class="button rate b4" data-value="4">4</button>
						<button type="button" class="button rate b5" data-value="5">5</button>
					</div>
				</section>
				<section class="block">
					<label for="comment" class="section-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
					<textarea id="comment" rows="3" placeholder="–í–∞—à–∏ –º—ã—Å–ª–∏..." maxlength="500"></textarea>
					<button type="button" class="link-btn" id="tell-more">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
					<button type="button" class="link-btn" id="tell-less" style="display:none;">–°–∫—Ä—ã—Ç—å</button>
					<div id="more" aria-hidden="true">
						<p class="small">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∑–∂–µ).</p>
					</div>
				</section>
			</div>
			<div class="sheet-footer">
				<button type="button" class="button ghost" id="cancel-feedback">–û—Ç–º–µ–Ω–∞</button>
				<button type="button" class="button attention-prima" id="submit-feedback">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
			</div>
		</div>
		<!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∏–¥–±–µ–∫-–ª–∏—Å—Ç–∞ -->
		<button id="open-feedback" class="fab" style="left:90px; bottom:24px; width:56px; height:56px; font-size:22px;">‚úâÔ∏è</button>

	<!-- Dialog –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (read-only) -->
	<div id="org-info-overlay" class="overlay" aria-hidden="true"></div>
	<div id="org-info-dialog" class="org-dialog org-dialog--info" role="dialog" aria-modal="true" aria-labelledby="org-info-title" aria-hidden="true">
		<div class="org-dialog__header">
			<h2 id="org-info-title">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</h2>
			<button class="icon-close small" id="org-info-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ"><i class="fa fa-times" aria-hidden="true"></i></button>
		</div>
		<div class="org-info-body" id="org-info-body">
			<p class="small">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
		</div>
		<div class="org-quick-comment" id="org-quick-comment" aria-live="polite">
			<div class="oqc-row">
				<textarea id="quick-comment-text" class="oqc-text" placeholder="–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–∑—ã–≤" rows="2" maxlength="500"></textarea>
			</div>
			<div class="oqc-actions">
				<button type="button" class="button attention-prima small" id="quick-comment-send" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
				<button type="button" class="button attention-tertia small" id="open-detailed-comment">–û—Ü–µ–Ω–∏—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ</button>
			</div>
			<div class="oqc-status" id="quick-comment-status"></div>
		</div>
		<div class="org-dialog__footer">
			<button type="button" class="button attention-tertia ghost" id="org-info-ok">–ó–∞–∫—Ä—ã—Ç—å</button>
		</div>
	</div>

<!-- –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ -->
<div id="detail-overlay" class="overlay" aria-hidden="true"></div>
<div id="detail-dialog" class="org-dialog org-dialog--detail" role="dialog" aria-modal="true" aria-labelledby="detail-title" aria-hidden="true">
	<div class="org-dialog__header">
		<h2 id="detail-title">–û—Ü–µ–Ω–∫–∞ –∑–∞–≤–µ–¥–µ–Ω–∏—è</h2>
		<button class="icon-close small" id="detail-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ"><i class="fa fa-times" aria-hidden="true"></i></button>
	</div>
	<form id="detail-form" novalidate>
		<input type="hidden" name="organization_id" id="detail-org-id" />
		<div class="detail-field">
			<label for="detail-text">–û–±—â–∏–π –æ—Ç–∑—ã–≤</label>
			<textarea id="detail-text" name="text" rows="3" placeholder="–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ"></textarea>
		</div>
		<div class="detail-grid" id="detail-grid">
			<!-- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: –≤—ã–±–æ—Ä —Å–º–∞–π–ª–∏–∫–æ–≤ 1-5 -->
			<div class="crit" data-key="appearance">
				<label>Appearance</label>
				<div class="crit-emojis" data-param="appearance"></div>
				<input type="hidden" name="appearance_value" />
			</div>
			<div class="crit" data-key="lighting">
				<label>Lighting</label>
				<div class="crit-emojis" data-param="lighting"></div>
				<input type="hidden" name="lighting_value" />
			</div>
			<div class="crit" data-key="smell">
				<label>Smell</label>
				<div class="crit-emojis" data-param="smell"></div>
				<input type="hidden" name="smell_value" />
			</div>
			<div class="crit" data-key="temperature">
				<label>Temperature</label>
				<div class="crit-emojis" data-param="temperature"></div>
				<input type="hidden" name="temperature_value" />
			</div>
			<div class="crit" data-key="tactility">
				<label>Tactility</label>
				<div class="crit-emojis" data-param="tactility"></div>
				<input type="hidden" name="tactility_value" />
			</div>
			<div class="crit" data-key="signage">
				<label>Signage</label>
				<div class="crit-emojis" data-param="signage"></div>
				<input type="hidden" name="signage_value" />
			</div>
			<div class="crit" data-key="intuitiveness">
				<label>Intuitiveness</label>
				<div class="crit-emojis" data-param="intuitiveness"></div>
				<input type="hidden" name="intuitiveness_value" />
			</div>
			<div class="crit" data-key="staff_attitude">
				<label>StaffAttitude</label>
				<div class="crit-emojis" data-param="staff_attitude"></div>
				<input type="hidden" name="staff_attitude_value" />
			</div>
			<div class="crit" data-key="people_density">
				<label>PeopleDensity</label>
				<div class="crit-emojis" data-param="people_density"></div>
				<input type="hidden" name="people_density_value" />
			</div>
			<div class="crit" data-key="self_service">
				<label>SelfService</label>
				<div class="crit-emojis" data-param="self_service"></div>
				<input type="hidden" name="self_service_value" />
			</div>
			<div class="crit" data-key="calmness">
				<label>Calmness</label>
				<div class="crit-emojis" data-param="calmness"></div>
				<input type="hidden" name="calmness_value" />
			</div>
		</div>
		<div class="detail-footer">
			<span class="detail-status" id="detail-status"></span>
			<div class="detail-actions">
				<button type="button" class="button attention-tertia ghost" id="detail-cancel">–û—Ç–º–µ–Ω–∞</button>
				<button type="submit" class="button attention-prima" id="detail-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
			</div>
		</div>
	</form>
</div>

	<!-- –û–≤–µ—Ä–ª–µ–π –∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
	<div id="auth-overlay" class="overlay" aria-hidden="true"></div>
	<div id="auth-dialog" class="auth-dialog" role="dialog" aria-modal="true" aria-labelledby="auth-dialog-title" aria-hidden="true">
		<div class="auth-dialog__header">
			<h2 id="auth-dialog-title">–í—Ö–æ–¥</h2>
			<button class="icon-close" id="auth-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ"><i class="fa fa-times" aria-hidden="true"></i></button>
		</div>
		<div class="auth-dialog__tabs" role="tablist">
			<button class="auth-tab active" data-mode="login" role="tab" aria-selected="true">–í—Ö–æ–¥</button>
			<button class="auth-tab" data-mode="register" role="tab" aria-selected="false">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
		</div>
		<form id="auth-form" novalidate>
			<div class="field-group" data-field="name" style="display:none;">
				<label for="auth-name">–ò–º—è</label>
				<input type="text" id="auth-name" name="name" autocomplete="name" placeholder="–í–∞—à–µ –∏–º—è" />
			</div>
			<div class="field-group">
				<label for="auth-email">Email</label>
				<input type="email" id="auth-email" name="email" autocomplete="email" required placeholder="you@example.com" />
			</div>
			<div class="field-group">
				<label for="auth-password">–ü–∞—Ä–æ–ª—å</label>
				<input type="password" id="auth-password" name="password" autocomplete="current-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="4" />
			</div>
			<div class="field-group" data-field="role" style="display:none;">
				<label for="auth-role">–†–æ–ª—å</label>
				<select id="auth-role" name="role">
					<option value="user" selected>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
					<option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
				</select>
			</div>
			<div class="auth-errors" id="auth-errors" aria-live="assertive"></div>
			<button type="submit" class="button attention-prima auth-submit">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
		</form>
		<div class="auth-dialog__footer">
			<button id="auth-logout" class="button attention-tertia ghost" style="display:none;">–í—ã–π—Ç–∏</button>
		</div>
		<!-- –ü—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
		<div id="user-profile" class="profile-panel" aria-hidden="true">
			<div class="profile-info">
				<p class="prof-line"><strong id="prof-name">‚Äî</strong></p>
				<p class="prof-line" id="prof-email">‚Äî</p>
				<p class="prof-line small" id="prof-role">‚Äî</p>
			</div>
			<form id="user-params-form" novalidate>
				<fieldset class="params-grid">
					<legend class="visually-hidden">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è</legend>
					<label class="param-item"><input type="checkbox" name="appearance"> <span>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</span></label>
					<label class="param-item"><input type="checkbox" name="lighting"> <span>–û—Å–≤–µ—â–µ–Ω–∏–µ</span></label>
					<label class="param-item"><input type="checkbox" name="smell"> <span>–ó–∞–ø–∞—Ö</span></label>
					<label class="param-item"><input type="checkbox" name="temperature"> <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span></label>
					<label class="param-item"><input type="checkbox" name="tactility"> <span>–¢–∞–∫—Ç–∏–ª—å–Ω–æ—Å—Ç—å</span></label>
					<label class="param-item"><input type="checkbox" name="signage"> <span>–£–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</span></label>
					<label class="param-item"><input type="checkbox" name="intuitiveness"> <span>–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ—Å—Ç—å</span></label>
					<label class="param-item"><input type="checkbox" name="staff_attitude"> <span>–û—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</span></label>
					<label class="param-item"><input type="checkbox" name="people_density"> <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π</span></label>
					<label class="param-item"><input type="checkbox" name="self_service"> <span>–°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</span></label>
					<label class="param-item"><input type="checkbox" name="calmness"> <span>–°–ø–æ–∫–æ–π–Ω–æ–µ –º–µ—Å—Ç–æ</span></label>
				</fieldset>
				<div class="params-actions">
					<button type="button" id="save-user-params" class="button attention-prima small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
					<span id="user-params-status" class="params-status" aria-live="polite"></span>
				</div>
			</form>
		</div>
	</div>
<!-- (feedback sheet JS removed) -->
<script>
// ===== –ü–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É =====
(function(){
	const openBtn = document.getElementById('open-search');
	const dlg = document.getElementById('search-dialog');
	const ov = document.getElementById('search-overlay');
	const closeBtn = document.getElementById('search-close');
	const cancelBtn = document.getElementById('search-cancel');
	const form = document.getElementById('search-form');
	const statusEl = document.getElementById('search-status');
	const listEl = document.getElementById('srp-list');
	const countEl = document.getElementById('srp-count');
	const panel = document.getElementById('search-results-panel');
	const clearBtn = document.getElementById('srp-clear');
	if(!window.APP) window.APP = {}; if(!window.APP.searchMarkers) window.APP.searchMarkers = [];

	function openSearch(){ dlg.classList.add('open'); dlg.removeAttribute('aria-hidden'); ov.classList.add('visible'); ov.removeAttribute('aria-hidden'); }
	function closeSearch(){ dlg.classList.remove('open'); dlg.setAttribute('aria-hidden','true'); ov.classList.remove('visible'); ov.setAttribute('aria-hidden','true'); }
	function clearMarkers(){
		if(window.APP.searchMarkers){ window.APP.searchMarkers.forEach(m=>{ try{ m.destroy(); }catch{} }); }
		window.APP.searchMarkers = [];
		panel.classList.add('hidden'); listEl.innerHTML=''; countEl.textContent='‚Äî';
	}
	function renderResults(items){
		clearMarkers();
		if(!items || !items.length){ statusEl.textContent='–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'; return; }
		if(!window.APP.map){ statusEl.textContent='–ù–µ—Ç –∫–∞—Ä—Ç—ã'; return; }
		const bounds = { minLon:Infinity, maxLon:-Infinity, minLat:Infinity, maxLat:-Infinity };
		items.forEach(it=>{
			const org = it.organization || {}; const lon = org.longitude; const lat = org.latitude;
			if(typeof lon !== 'number' || typeof lat !== 'number') return;
			if(lon<bounds.minLon) bounds.minLon=lon; if(lon>bounds.maxLon) bounds.maxLon=lon; if(lat<bounds.minLat) bounds.minLat=lat; if(lat>bounds.maxLat) bounds.maxLat=lat;
			const marker = new mapgl.Marker(window.APP.map, { coordinates:[lon,lat] });
			window.APP.searchMarkers.push(marker);
		});
		countEl.textContent = '–ù–∞–π–¥–µ–Ω–æ: '+items.length;
		listEl.innerHTML = items.map(it=>{
			const org = it.organization||{}; const avg = it.average != null ? it.average.toFixed(2) : '‚Äî';
			return `<div class="srp-item"><span class="srp-addr">${(org.address||'-')}</span><span class="srp-avg">${avg}</span></div>`;
		}).join('');
		panel.classList.remove('hidden');
		// –∞–≤—Ç–æ-–ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ (–ø—Ä–æ—Å—Ç–æ–µ)
		if(window.APP.searchMarkers.length){
			try {
				const cx = (bounds.minLon + bounds.maxLon)/2; const cy = (bounds.minLat + bounds.maxLat)/2;
				window.APP.map.setCenter([cx, cy]);
			} catch{}
		}
	}
	async function performSearch(body){
		statusEl.textContent='–ü–æ–∏—Å–∫...'; statusEl.className='field-group small-info searching';
		try {
			const res = await fetch(`${ORG_API}/organization/params/average/by-type`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
			let data=null; try{ data=await res.json(); }catch{ data={}; }
			if(!res.ok){ statusEl.textContent = data.error||('–û—à–∏–±–∫–∞ '+res.status); statusEl.className='field-group small-info error'; return; }
			statusEl.textContent='–ì–æ—Ç–æ–≤–æ'; statusEl.className='field-group small-info ok';
			renderResults(data.items||[]);
		} catch(e){ statusEl.textContent='–°–µ—Ç—å: '+e.message; statusEl.className='field-group small-info error'; }
	}
	form.addEventListener('submit', async (e)=>{
		e.preventDefault();
		const orgType = form.organization_type.value.trim();
		const thrRaw = form.threshold.value.trim();
		if(!orgType){ statusEl.textContent='–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø'; statusEl.className='field-group small-info error'; return; }
		// –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
		const paramNames = await getUserParamNames();
		const body = { organization_type: orgType, params: paramNames };
		if(thrRaw){ const thr = parseFloat(thrRaw); if(!isNaN(thr)) body.threshold = thr; }
		performSearch(body);
	});
	openBtn?.addEventListener('click', openSearch);
	closeBtn?.addEventListener('click', closeSearch);
	cancelBtn?.addEventListener('click', closeSearch);
	ov?.addEventListener('click', closeSearch);
	clearBtn?.addEventListener('click', clearMarkers);
	document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && dlg.classList.contains('open')) closeSearch(); });
})();
</script>
<script>
// –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É –∏ –ø–æ—Ä–æ–≥—É
(function(){
	if(!window.APP) window.APP = {}; if(!window.APP.searchMarkers) window.APP.searchMarkers = [];
	const panel = document.getElementById('side-search-panel');
	const toggleBtn = document.getElementById('side-search-toggle');
	const closeBtn = document.getElementById('side-search-close');
	const form = document.getElementById('side-search-form');
	const statusEl = document.getElementById('ssp-status');
	const resultsEl = document.getElementById('ssp-results');
	const clearBtn = document.getElementById('ssp-clear');
	const typeInput = document.getElementById('ssp-type');
	const thrInput = document.getElementById('ssp-threshold');

	function openPanel(){ panel.classList.add('open'); panel.removeAttribute('aria-hidden'); toggleBtn.setAttribute('aria-expanded','true'); }
	function closePanel(){ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); toggleBtn.setAttribute('aria-expanded','false'); }
	toggleBtn?.addEventListener('click', ()=>{ panel.classList.contains('open')? closePanel(): openPanel(); });
	closeBtn?.addEventListener('click', closePanel);
	document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && panel.classList.contains('open')) closePanel(); });

	function clearMarkers(){ if(window.APP.searchMarkers){ window.APP.searchMarkers.forEach(m=>{ try{ m.destroy(); }catch{} }); } window.APP.searchMarkers = []; }
	function resetResults(){ clearMarkers(); resultsEl.innerHTML=''; clearBtn.disabled = true; }
	clearBtn.addEventListener('click', ()=>{ resetResults(); statusEl.textContent=''; });

	function renderItems(items){
		resetResults();
		if(!items || !items.length){ statusEl.textContent='–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'; return; }
		if(!window.APP.map){ statusEl.textContent='–ö–∞—Ä—Ç–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞'; return; }
		const bounds = { minLon:Infinity, maxLon:-Infinity, minLat:Infinity, maxLat:-Infinity };
		const frag = document.createDocumentFragment();
		items.forEach(it=>{
			const org = it.organization||{}; const lon = org.longitude; const lat = org.latitude;
			if(typeof lon !== 'number' || typeof lat !== 'number') return;
			if(lon<bounds.minLon) bounds.minLon=lon; if(lon>bounds.maxLon) bounds.maxLon=lon; if(lat<bounds.minLat) bounds.minLat=lat; if(lat>bounds.maxLat) bounds.maxLat=lat;
			const marker = new mapgl.Marker(window.APP.map, { coordinates:[lon,lat] });
			window.APP.searchMarkers.push(marker);
			const row = document.createElement('div');
			row.className='ssp-item';
			const avg = (it.average!=null)? Number(it.average).toFixed(2):'‚Äî';
			row.innerHTML = `<span class="addr">${org.address||'-'}</span><span class="avg">${avg}</span>`;
			row.addEventListener('click', ()=>{ try { window.APP.map.setCenter([lon,lat]); window.APP.map.setZoom && window.APP.map.setZoom(16); } catch{} });
			frag.appendChild(row);
		});
		resultsEl.appendChild(frag);
		clearBtn.disabled = false;
		statusEl.textContent = '–ù–∞–π–¥–µ–Ω–æ: '+window.APP.searchMarkers.length;
		if(window.APP.searchMarkers.length){ try { const cx=(bounds.minLon+bounds.maxLon)/2; const cy=(bounds.minLat+bounds.maxLat)/2; window.APP.map.setCenter([cx,cy]); } catch{} }
	}

	async function performSearch(body){
		statusEl.textContent='–ü–æ–∏—Å–∫...'; statusEl.classList.remove('error');
		try {
			const res = await fetch(`${ORG_API}/organization/params/average/by-type`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
			let data=null; try{ data=await res.json(); }catch{ data={}; }
			if(!res.ok){ statusEl.textContent=data.error||('–û—à–∏–±–∫–∞ '+res.status); statusEl.classList.add('error'); return; }
			renderItems(data.items||[]);
		} catch(e){ statusEl.textContent='–°–µ—Ç—å: '+e.message; statusEl.classList.add('error'); }
	}

	form.addEventListener('submit', async (e)=>{
		e.preventDefault();
		const orgType = typeInput.value.trim();
		if(!orgType){ statusEl.textContent='–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø'; statusEl.classList.add('error'); return; }
		const params = await getUserParamNames();
		const body = { organization_type: orgType, params };
		const thrRaw = thrInput.value.trim(); if(thrRaw){ const thr=parseFloat(thrRaw); if(!isNaN(thr)) body.threshold=thr; }
		performSearch(body);
	});
})();
</script>
<script>
// –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã–º bottom-sheet (feedback) —Å null-safe –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
(() => {
	const sheet = document.getElementById('feedback-sheet');
	const overlay = document.getElementById('sheet-overlay');
	const openBtn = document.getElementById('open-feedback');
	const closeBtn = document.getElementById('close-sheet');
	const cancelBtn = document.getElementById('cancel-feedback');
	const tellMore = document.getElementById('tell-more');
	const tellLess = document.getElementById('tell-less');
	const more = document.getElementById('more');
	const submitBtn = document.getElementById('submit-feedback');
	const commentInput = document.getElementById('comment');
	const ratingButtons = document.querySelectorAll('.rate');
	let currentRating = null;

	function openSheet(){ if(!sheet||!overlay) return; sheet.classList.add('open'); overlay.classList.add('visible'); overlay.removeAttribute('aria-hidden'); document.body.classList.add('noscroll'); }
	function closeSheet(){ if(!sheet||!overlay) return; sheet.classList.remove('open'); overlay.classList.remove('visible'); overlay.setAttribute('aria-hidden','true'); document.body.classList.remove('noscroll'); }

	openBtn?.addEventListener('click', openSheet);
	overlay?.addEventListener('click', closeSheet);
	closeBtn?.addEventListener('click', closeSheet);
	cancelBtn?.addEventListener('click', closeSheet);

	tellMore?.addEventListener('click', () => { if(!more||!tellMore) return; more.classList.add('expanded'); more.setAttribute('aria-hidden','false'); tellMore.style.display='none'; });
	tellLess?.addEventListener('click', () => { if(!more||!tellMore) return; more.classList.remove('expanded'); more.setAttribute('aria-hidden','true'); tellMore.style.display='inline-block'; });

	ratingButtons.forEach(btn => {
		btn.addEventListener('click', () => {
			ratingButtons.forEach(b => b.classList.remove('selected'));
			btn.classList.add('selected');
			currentRating = btn.dataset.value;
		});
	});

	submitBtn?.addEventListener('click', () => {
		console.log('Submit rating:', currentRating, 'comment:', commentInput?.value);
		closeSheet();
	});

	document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && sheet?.classList.contains('open')) closeSheet(); });
})();
</script>
</body>
</html>
